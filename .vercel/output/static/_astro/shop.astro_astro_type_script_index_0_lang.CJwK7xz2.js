let c=[];const g=document.getElementById("cart-sidebar"),F=document.getElementById("cart-overlay"),v=document.getElementById("cart-items"),w=document.getElementById("cart-total"),s=document.getElementById("checkout-btn"),C=document.getElementById("close-cart"),$="junkerri-cart";function R(){try{const t=localStorage.getItem($);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load cart from localStorage:",t),[]}}function h(t){try{localStorage.setItem($,JSON.stringify(t))}catch(e){console.error("Failed to save cart to localStorage:",e)}}c=R();console.log("üõí Cart loaded from storage:",c);p();y();let u={},q={};function I(){console.log("üõí Starting to update product data...");const t=document.querySelectorAll("[data-product-id]");console.log(`üõí Found ${t.length} product buttons`),t.forEach(e=>{const o=e.getAttribute("data-product-id"),r=e.getAttribute("data-price-id"),n=e.closest(".product-item");if(!n){console.warn("No product container found for button:",o);return}const a=n.querySelector("h3")?.textContent,i=n.querySelector(".text-primary")?.textContent,l=n.querySelector("img")?.getAttribute("src");if(console.log("üõí Processing product:",{productId:o,productName:a,productPrice:i,productImage:l,productPriceId:r}),o&&a&&i&&l&&r){const f=parseFloat(i.replace("$",""));u[o]={name:a,price:f,image:l,priceId:r},console.log(`‚úÖ Added product data for ${o}:`,u[o])}else console.warn("Missing data for product:",{productId:o,productName:a,productPrice:i,productImage:l,productPriceId:r})}),console.log("üõí Final product data for cart:",u),p(),z()}function z(){console.log("üîß Setting up cart event listeners..."),document.querySelectorAll("[data-product-id]").forEach(t=>{t.removeEventListener("click",S),t.addEventListener("click",S)}),console.log(`üîß Added event listeners to ${document.querySelectorAll("[data-product-id]").length} buttons`)}function S(t){const o=t.currentTarget.getAttribute("data-product-id");if(!o){console.warn("No product ID found on button");return}console.log("üõí Add to cart clicked for product:",o),console.log("üõí Available product data:",u);const r=u[o];if(!r){console.warn("Product data not found for:",o),d("Product data not available. Please refresh the page.","error");return}const n=q[o]||null,a=n?`${o}__${n}`:o,i=c.find(l=>l.id===a);i?(i.quantity+=1,d(`Updated quantity for ${r.name}`,"success")):(c.push({id:a,priceId:r.priceId,name:n?`${r.name} (${n})`:r.name,price:r.price,image:r.image,quantity:1}),d(`Added ${r.name} to cart`,"success")),p(),h(c),k()}function p(){if(!v||!w||!s)return;v.innerHTML=c.map(e=>`
        <div class="flex w-full items-center gap-3 p-4 border border-border rounded-lg bg-background/50" data-cart-item-id="${e.id}">
          <img src="${e.image}" alt="${e.name}" class="w-14 h-14 object-cover rounded shrink-0" />
          <div class="flex-1 min-w-0">
            <h4 class="font-medium truncate">${e.name}</h4>
            <p class="text-sm text-muted-foreground">$${e.price}</p>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <button class="quantity-btn-decrease text-muted-foreground hover:text-foreground p-1 rounded" data-product-id="${e.id}" aria-label="Decrease quantity">-</button>
            <span class="w-8 text-center">${e.quantity}</span>
            <button class="quantity-btn-increase text-muted-foreground hover:text-foreground p-1 rounded" data-product-id="${e.id}" aria-label="Increase quantity">+</button>
          </div>
          <button class="remove-btn text-red-500 hover:text-red-700 p-1 shrink-0" data-product-id="${e.id}" aria-label="Remove item">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      `).join(""),N();const t=c.reduce((e,o)=>e+o.price*o.quantity,0);w.textContent=`$${t.toFixed(2)}`,M(t),s.disabled=c.length===0,y(),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{count:c.reduce((e,o)=>e+o.quantity,0)}}))}function M(t){const e=document.getElementById("standard-shipping-text");e&&(t>=75?(e.textContent="Standard Shipping: FREE (3-7 business days)",e.className="text-green-600 font-medium"):(e.textContent=`Standard Shipping: $5.00 (3-7 business days) - Add $${(75-t).toFixed(2)} more for free shipping!`,e.className="text-muted-foreground"))}function N(){document.querySelectorAll(".quantity-btn-decrease").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.getAttribute("data-product-id");o&&A(o,-1)})}),document.querySelectorAll(".quantity-btn-increase").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.getAttribute("data-product-id");o&&A(o,1)})}),document.querySelectorAll(".remove-btn").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget.getAttribute("data-product-id");o&&U(o)})})}function A(t,e){const o=c.find(r=>r.id===t);o&&(o.quantity+=e,o.quantity<=0&&(c=c.filter(r=>r.id!==t)),p(),h(c))}function U(t){c=c.filter(e=>e.id!==t),p(),h(c),d("Item removed from cart","info")}function k(){g&&g.classList.remove("translate-x-full")}function L(){g&&g.classList.add("translate-x-full")}function y(){const t=document.querySelector(".cart-badge");if(t){const e=c.reduce((o,r)=>o+r.quantity,0);t.textContent=e.toString(),t.classList.toggle("hidden",e===0)}}C&&C.addEventListener("click",L);window.addEventListener("openCart",()=>{console.log("üõí Header cart button clicked, opening cart..."),k()});console.log("üõí Cart script loaded");console.log("üõí Initial cart state:",c);console.log("üõí Cart elements found:",{cartSidebar:!!g,cartOverlay:!!F,cartItems:!!v,cartTotal:!!w,checkoutBtn:!!s});s&&s.addEventListener("click",async()=>{if(c.length!==0)try{s.disabled=!0,s.innerHTML=`
            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Creating Checkout...
          `;const t=c.map(a=>({price:a.priceId,quantity:a.quantity}));console.log("üõí Creating checkout session for:",t);const e=window.location.href;console.log("üåê Current page URL for redirect:",e);const o=c.reduce((a,i)=>a+i.price*i.quantity,0);console.log("üí∞ Order total for shipping:",o);const r=await fetch("/api/stripe/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:t,currentPageUrl:e,orderTotal:o})});if(console.log("üõí Checkout response status:",r.status),console.log("üõí Checkout response headers:",r.headers),!r.ok){const a=await r.text();throw console.error("‚ùå Checkout API error response:",a),new Error(`HTTP error! status: ${r.status}, response: ${a}`)}const n=await r.json();if(n.success&&n.url)console.log("‚úÖ Redirecting to Stripe checkout..."),d("Redirecting to checkout...","success"),L(),window.location.href=n.url;else throw new Error(n.error||"Checkout failed")}catch(t){console.error("‚ùå Checkout error:",t),d(`Checkout failed: ${t instanceof Error?t.message:"Unknown error"}`,"error")}finally{s.disabled=!1,s.innerHTML="Proceed to Checkout"}});function d(t,e="info"){const o=document.querySelector(".notification");o&&o.remove();const r=document.createElement("div");r.className=`notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 ${e==="success"?"bg-green-500 text-white":e==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,r.innerHTML=`
        <div class="flex items-center gap-2">
          <span>${t}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      `,document.body.appendChild(r),setTimeout(()=>{r.parentElement&&r.remove()},5e3)}const m=document.querySelectorAll(".category-filter"),H=document.querySelectorAll(".product-item");function T(t){m.forEach(e=>e.removeAttribute("data-active")),t.setAttribute("data-active","true")}function P(t){H.forEach(e=>{const o=t==="All"||e.getAttribute("data-category")===t;e.classList.toggle("hidden",!o)}),history.replaceState(null,"",`#${encodeURIComponent(t)}`)}m.forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-category");e&&(T(t),P(e))})});const B=decodeURIComponent(location.hash?.replace("#","")||"All"),E=Array.from(m).find(t=>t.getAttribute("data-category")===B)||Array.from(m).find(t=>t.getAttribute("data-category")==="All");E&&(T(E),P(B));setTimeout(()=>{I(),y(),j(),D()},100);const O=new URLSearchParams(window.location.search).get("cart");O==="open"&&setTimeout(()=>k(),250);function j(){const t=new URLSearchParams(window.location.search),e=t.get("success"),o=t.get("canceled");e==="true"?(d("Payment successful! Thank you for your purchase.","success"),c=[],h(c),p(),window.history.replaceState({},document.title,window.location.pathname)):o==="true"&&(d("Payment was canceled. Your cart items are still available.","info"),window.history.replaceState({},document.title,window.location.pathname))}function x(){const t=document.querySelector(".grid");if(!t){console.log("üõçÔ∏è Product grid not found, waiting..."),setTimeout(x,100);return}const e=t.querySelectorAll(".product-item");e.length>0?(console.log(`üõçÔ∏è Found ${e.length} products, setting up cart...`),I(),y()):(console.log("üõçÔ∏è Products not yet rendered, waiting..."),setTimeout(x,200))}function D(){const t=document.querySelectorAll(".size-btn");t.forEach(e=>{e.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const r=o.currentTarget,n=r.getAttribute("data-target-product"),a=r.getAttribute("data-size"),i=r.getAttribute("data-price");if(!n||!a||!i)return;console.log(`üéØ Size button clicked: ${a} for product ${n} at price $${i}`),t.forEach(b=>{b.getAttribute("data-target-product")===n&&(b.classList.remove("bg-primary","text-white","border-primary"),b.classList.add("border-input","bg-background","text-white"))}),r.classList.remove("border-input","bg-background","text-foreground"),r.classList.add("bg-primary","text-white","border-primary");const f=r.closest(".product-item")?.querySelector(".text-primary");f?(f.textContent=`$${i}`,console.log(`üí∞ Updated price for ${n} to $${i}`)):console.log(`‚ùå Could not find price element for ${n}`),u[n]&&(u[n].price=parseFloat(i)),q[n]=a})})}x();
